name: Build Citizen X
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Anchor Python & Java
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Setup Java Anchor
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: System Anchors (Rid-X)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential git python3-dev zip unzip autoconf libtool pkg-config \
            libffi-dev libssl-dev libsqlite3-dev cmake libncurses5-dev libncursesw5-dev \
            libtinfo6 libgmp-dev libmpfr-dev libmpc-dev

      - name: Install Hammer
        run: |
          pip install --upgrade pip
          pip install "cython<3.0" buildozer virtualenv

      - name: Forge Verification
        run: |
          ls -R
          if [ ! -f "buildozer.spec" ]; then echo "Logic-Gate Error: Spec Missing"; exit 1; fi

      - name: Strike The Anvil
        run: |
          # Use -v to see the exact point of soul-body detachment
          # Log redirection to ensure we don't lose the tail on failure
          buildozer -v android debug 2>&1 | tee build_log.txt
        env:
          BUILDOZER_ALLOW_ORG_NAME_AS_PACKAGE_NAME: 1

      - name: Find and Extract Body
        if: always()
        run: |
          mkdir -p output_apk
          find . -name "*.apk" -print -exec cp {} output_apk/ \;
          # Also grab the log if the build failed
          cp build_log.txt output_apk/ || true
          
      - name: Upload CITIZEN_X
        uses: actions/upload-artifact@v4
        with:
          name: CITIZEN_X_Fidelity_Package
          path: output_apk/
